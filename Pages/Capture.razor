@page "/capture/{PlanogramId}"
@inject PlanogramDataService PlanogramData
@inject PhotoStoreService PhotoStore
@inject NavigationManager Navigation

<PageTitle>Capture â€” @(_planogram?.Name ?? "Planogram")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="capture-page">
    @if (_planogram is null)
    {
        <MudAlert Severity="Severity.Error">Planogram not found.</MudAlert>
        <MudButton Variant="Variant.Text" OnClick="BackToHome">Back to home</MudButton>
    }
    else if (_currentSegmentIndex >= _planogram.NumberOfSegments)
    {
        <MudPaper Class="capture-done" Elevation="1">
            <MudText Typo="Typo.h5">All segments captured</MudText>
            <MudText Typo="Typo.body2">You have taken photos for all segments in <strong>@_planogram.Name</strong>.</MudText>
            <PhotoDownloads Planogram="_planogram" />
            <div class="done-actions">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="BackToHome">Back to planograms</MudButton>
            </div>
        </MudPaper>
    }
    else
    {
        <div class="capture-header">
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" OnClick="BackToHome">
                Planograms
            </MudButton>
        </div>

        <CameraCapture Planogram="_planogram"
                       CurrentIndex="_currentSegmentIndex"
                       OnSegmentCaptured="OnSegmentCaptured" />
    }
</MudContainer>

@code {
    [Parameter]
    public string PlanogramId { get; set; } = "";

    private Planogram? _planogram;
    private int _currentSegmentIndex;

    protected override void OnInitialized()
    {
        _planogram = PlanogramData.GetPlanogram(PlanogramId);
        _currentSegmentIndex = 0;
    }

    private void OnSegmentCaptured(int capturedIndex)
    {
        _currentSegmentIndex = capturedIndex + 1;
        StateHasChanged();
    }

    private void BackToHome()
    {
        if (_planogram is not null)
        {
            PhotoStore.ClearPlanogram(_planogram.Id);
        }
        Navigation.NavigateTo(Navigation.BaseUri);
    }
}
