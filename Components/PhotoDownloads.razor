@inject PhotoStoreService PhotoStore
@inject IJSRuntime JS

@if (Planogram is not null)
{
    var photos = GetPhotos();
    <MudPaper Class="photo-downloads" Elevation="0">
        <div class="downloads-header">
            <MudText Typo="Typo.h6">Download photos</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="DownloadAll" Disabled="@(photos.Count == 0)">
                Download all
            </MudButton>
        </div>
        @if (photos.Count == 0)
        {
            <MudText Typo="Typo.body2" Class="downloads-empty">No photos found for this planogram.</MudText>
        }
        else
        {
            <MudGrid Class="downloads-grid" Spacing="2">
                @foreach (var item in photos)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudCard Class="download-card" Elevation="1">
                            <MudCardMedia Image="@item.DataUrl" Class="download-media" />
                            <MudCardActions Class="download-meta">
                                <MudText Typo="Typo.caption" Class="segment-name">@item.SegmentName</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => DownloadOne(item)">
                                    Download
                                </MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
    </MudPaper>
}

@code {
    [Parameter] public Planogram? Planogram { get; set; }

    private List<PhotoItem> GetPhotos()
    {
        if (Planogram is null) return new List<PhotoItem>();
        return Enumerable.Range(1, Planogram.NumberOfSegments)
            .Select(segmentNumber => new PhotoItem
            {
                SegmentNumber = segmentNumber,
                SegmentName = $"Segment {segmentNumber}",
                DataUrl = PhotoStore.GetPhoto(Planogram.Id, segmentNumber) ?? string.Empty
            })
            .Where(item => !string.IsNullOrWhiteSpace(item.DataUrl))
            .ToList();
    }

    private async Task DownloadOne(PhotoItem item)
    {
        if (Planogram is null) return;
        var filename = $"{Planogram.Name}-{item.SegmentName}.jpg".Replace(' ', '_');
        await JS.InvokeVoidAsync("PlanogramCamera.downloadDataUrl", filename, item.DataUrl);
    }

    private async Task DownloadAll()
    {
        var photos = GetPhotos();
        foreach (var item in photos)
        {
            await DownloadOne(item);
        }
    }

    private sealed class PhotoItem
    {
        public int SegmentNumber { get; set; }
        public string SegmentName { get; set; } = string.Empty;
        public string DataUrl { get; set; } = string.Empty;
    }
}
